<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Date-time arithmetic • clock</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Date-time arithmetic">
<meta property="og:description" content="clock">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">clock</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/clock-arithmetic.html">Date-time arithmetic</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DavisVaughan/clock/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="clock-arithmetic_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Date-time arithmetic</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DavisVaughan/clock/blob/master/vignettes/clock-arithmetic.Rmd"><code>vignettes/clock-arithmetic.Rmd</code></a></small>
      <div class="hidden name"><code>clock-arithmetic.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/clock">clock</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></code></pre></div>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Date time arithmetic is often complicated. Dealing with leap years, daylight savings times, and inexact periods of time can often lead to a large amount of ambiguity about what the “right” thing to do is. For example, consider the date of <code>"2019-01-31"</code>. If we want to add 1 month to that, what should the result be? There are a few options:</p>
<ul>
<li><p>Since <code>"2019-02-31"</code> isn’t a real date, we could return <code>NA</code>.</p></li>
<li><p>It is also reasonable that we just wanted the end of February, so we could map the nonexistent day of <code>"2019-02-31"</code> to <code>"2019-02-28"</code>.</p></li>
<li><p>Similarly, we could roll forward to the start of the next month, <code>"2019-03-01"</code>.</p></li>
</ul>
<p>The important thing is that there is no <em>right</em> answer, but often one is more common than the others. Here, I think most people would agree that that means mapping to the end of February and returning <code>"2019-02-28"</code>.</p>
<p>With doing arithmetic with clock, the goal is to be <em>flexible</em>, providing many options for you to choose from, but also <em>predictable</em>, providing defaults that align with the most common results.</p>
<p>The goal of this vignette is to walk through the three main issues that may arise in date-time arithmetic, explaining the defaults and options that clock exposes to you. These three issues are:</p>
<ul>
<li><p>Nonexistent dates due to period arithmetic</p></li>
<li><p>Nonexistent times due to daylight savings gaps</p></li>
<li><p>Ambiguous times due to daylight savings fallbacks</p></li>
</ul>
<p>Additionally, we will discuss using a <em>local</em> date-time vector to do more complex date-time arithmetic involving multiple units of time.</p>
</div>
<div id="nonexistent-dates-due-to-period-arithmetic" class="section level2">
<h2 class="hasAnchor">
<a href="#nonexistent-dates-due-to-period-arithmetic" class="anchor"></a>Nonexistent dates due to period arithmetic</h2>
<p>Our original example in the Introduction demonstrates a nonexistent date that can occur from the inexactness of period arithmetic. To make it a bit more interesting, we will also add a time of day.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2019-01-31 09:30:00"</span>, <span class="st">"America/New_York"</span><span class="op">)</span>

<span class="co"># x + "1 month" = "2019-02-31 09:30:00"</span>
<span class="co"># but this entire day doesn't exist!</span></code></pre></div>
<p>As mentioned before, there are a number of options to resolve this. The full set is:</p>
<ul>
<li><p>Return the last possible time in the current month.</p></li>
<li><p>Return the first possible time in the following month.</p></li>
<li><p>Return the last day in the current month, retaining the time of day.</p></li>
<li><p>Return the first day in the following month, retaining the time of day.</p></li>
<li><p>Return an <code>NA</code> because this date doesn’t exist.</p></li>
<li><p>Error because this date doesn’t exist.</p></li>
</ul>
<p>In clock, the default behavior is the first option, the last possible time in the current month will be returned.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span>

<span class="fu"><a href="../reference/clock-arithmetic.html">add_months</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>But there is nothing stopping you from choosing a different behavior. You can adjust the default behavior with <code>day_nonexistent</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span>

<span class="fu"><a href="../reference/clock-arithmetic.html">add_months</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, day_nonexistent <span class="op">=</span> <span class="st">"first-time"</span><span class="op">)</span>

<span class="fu"><a href="../reference/clock-arithmetic.html">add_months</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, day_nonexistent <span class="op">=</span> <span class="st">"last-day"</span><span class="op">)</span></code></pre></div>
<p>In isolation, it might seem intuitive to keep the original time of day using <code>"last-day"</code>, but this can be dangerous when doing data science, which often involves a vector of dates rather than just one. Retaining the original time of day can alter the relative ordering within the vector, which can cause many issues. See the section on Relative Ordering for more information.</p>
</div>
<div id="nonexistent-times-due-to-daylight-savings-gaps" class="section level2">
<h2 class="hasAnchor">
<a href="#nonexistent-times-due-to-daylight-savings-gaps" class="anchor"></a>Nonexistent times due to daylight savings gaps</h2>
<p>Daylight savings time introduces a number of strange cases that have to be handled when doing date-time arithmetic. One of these arises when you have a “gap” in time when clocks are moved forward. In most parts of the world, clocks move forward by 1 hour. For example, if you add a duration of 1 second to <code>"1970-04-26 01:59:59"</code> in the <code>"America/New_York"</code> time zone, then you immediately land in <code>"1970-04-26 03:00:00"</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"1970-04-26 01:59:59"</span>, <span class="st">"America/New_York"</span><span class="op">)</span>

<span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></code></pre></div>
<p>Issues arise when you add or subtract periods of time that land you directly in the gap. For example, adding 1 day to the date-time below would land you right in the daylight savings gap between <code>(01:59:59, 03:00:00)</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"1970-04-25 02:30:00"</span>, <span class="st">"America/New_York"</span><span class="op">)</span>

<span class="co"># x + 1 day = "1970-04-26 02:30:00"</span>
<span class="co"># but this doesn't exist!</span></code></pre></div>
<p>There are multiple options here to resolve this nonexistent day:</p>
<ul>
<li><p>Adjust to the <em>next</em> instant in time after the gap.</p></li>
<li><p>Adjust to the <em>previous</em> instant in time before the gap.</p></li>
<li><p><em>Shift</em> forward by adding the size of the gap (1 hour) to our nonexistent time.</p></li>
<li><p><em>Shift</em> backwards by subtracting the size of the gap from our nonexistent time.</p></li>
<li><p>Return <code>NA</code> because this time didn’t exist.</p></li>
<li><p>Return an error.</p></li>
</ul>
<p>Rather than forcing one of these options on you, clock exposes them all through the <code>dst_nonexistent</code> argument, but tries to default to the most common case. Here, that means adjusting to the next instant after the gap.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>But you are more than welcome to choose the other options:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, dst_nonexistent <span class="op">=</span> <span class="st">"roll-backward"</span><span class="op">)</span>

<span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, dst_nonexistent <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></code></pre></div>
<div id="shifting" class="section level3">
<h3 class="hasAnchor">
<a href="#shifting" class="anchor"></a>Shifting</h3>
<p>The <em>shifting</em> options deserve special mention. The following will add the 1 hour gap to the nonexistent time of <code>02:30:00</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, dst_nonexistent <span class="op">=</span> <span class="st">"shift-forward"</span><span class="op">)</span></code></pre></div>
<p>A word of warning about this. While it might seem convenient in isolation, this behavior can be very problematic when used with a vector of dates because it doesn’t preserve the <em>relative ordering</em> within that vector. For examples, see the Relative Ordering section below.</p>
</div>
<div id="direction" class="section level3">
<h3 class="hasAnchor">
<a href="#direction" class="anchor"></a>Direction</h3>
<p>Consider what happens when you approach from the other side of the gap. Let’s subtract 1 day from this time, rather than adding 1 day.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"1970-04-27 02:30:00"</span>, <span class="st">"America/New_York"</span><span class="op">)</span>

<span class="co"># y - 1 day = "1970-04-26 02:30:00"</span>
<span class="co"># but this doesn't exist!</span></code></pre></div>
<p>To resolve this nonexistent date, it seems intuitive to take into account the <em>direction</em> that you are traveling when performing this arithmetic. Rather than rolling forward to <code>03:00:00</code>, it makes sense to roll back to the previous instant in time of <code>01:59:59</code> since that matches the direction of travel you are already moving in.</p>
<p>To handle this, the <code>dst_nonexistent</code> argument defaults to <code>"roll-directional"</code>, which chooses <code>"roll-forward"</code> if you are adding time and <code>"roll-backward"</code> if you are subtracting it. This hopefully gives the most intuitive result of:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clock-arithmetic.html">subtract_days</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>But again you can change this if you did want <code>03:00:00</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clock-arithmetic.html">subtract_days</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span>, dst_nonexistent <span class="op">=</span> <span class="st">"roll-forward"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="ambiguous-times-due-to-daylight-savings-fallbacks" class="section level2">
<h2 class="hasAnchor">
<a href="#ambiguous-times-due-to-daylight-savings-fallbacks" class="anchor"></a>Ambiguous times due to daylight savings fallbacks</h2>
<p>On one side of the daylight savings coin, there are gaps. On the other, there are fallbacks. These result in a unit of time being repeated on your clock. For example, adding a duration of 1 second to <code>"1970-10-25 00:59:59"</code> in the <code>"America/New_York"</code> time zone results in <code>01:00:00 EDT</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"1970-10-25 00:59:59"</span>, <span class="st">"America/New_York"</span><span class="op">)</span>
<span class="va">x</span>

<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span>
<span class="va">y</span></code></pre></div>
<p>Moving forward 1 hour from that, when <code>01:59:59 EDT</code> advances by 1 second, we shift the clocks backwards by 1 hour, resulting in <code>01:00:00 EST</code>. This gives us two hours of time that both align with the idea of “1 AM”.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span>

<span class="va">y</span> <span class="op">+</span> <span class="fl">3599</span>

<span class="va">y</span> <span class="op">+</span> <span class="fl">3600</span></code></pre></div>
<p>Issues arise when you consider adding periods of time that land you in this ambiguous zone.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"1970-09-25 01:30:00"</span>, <span class="st">"America/New_York"</span><span class="op">)</span>

<span class="co"># x + 1 month = "1970-10-25 01:30:00"</span>
<span class="co"># but which one? EDT or EST?</span></code></pre></div>
<p>There are a few options here:</p>
<ul>
<li><p>Choose the <em>earliest</em> of the two ambiguous times (before the fallback).</p></li>
<li><p>Choose the <em>latest</em> of the two ambiguous times (after the fallback).</p></li>
<li><p>Return <code>NA</code> because it is unclear how to proceed.</p></li>
<li><p>Return an error.</p></li>
</ul>
<p>Again, clock exposes all of these options to you through the <code>dst_ambiguous</code> option, but tries to choose the most intuitive one. Here, that means choosing the earliest of the two ambiguous times since you are adding months and are approaching it from before the fallback happened.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clock-arithmetic.html">add_months</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>If you wanted the latest time, you can use:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clock-arithmetic.html">add_months</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, dst_ambiguous <span class="op">=</span> <span class="st">"latest"</span><span class="op">)</span></code></pre></div>
<div id="direction-1" class="section level3">
<h3 class="hasAnchor">
<a href="#direction-1" class="anchor"></a>Direction</h3>
<p>Like with <code>dst_nonexistent</code>, the direction that you approach from can influence what you expect the result of this arithmetic to be. Let’s shift past the fallback time, and then subtract a month:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"1970-11-25 01:30:00"</span>, <span class="st">"America/New_York"</span><span class="op">)</span>
<span class="va">x</span>

<span class="co"># x - 1 month = "1970-10-25 01:30:00"</span>
<span class="co"># but which one?</span></code></pre></div>
<p>In this case, since you started past when the fallback happened, you probably would like to get the second occurrence of this time, i.e. the <code>"latest"</code> one. <code>dst_ambiguous</code> also defaults to <code>"directional"</code>, which knows to choose <code>"earliest"</code> when adding time, and <code>"latest"</code> when subtracting time. This should result in the most intuitive behavior of:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clock-arithmetic.html">subtract_months</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>But if you wanted the earliest occurrence, you could still get that:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/clock-arithmetic.html">subtract_months</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, dst_ambiguous <span class="op">=</span> <span class="st">"earliest"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="relative-ordering" class="section level2">
<h2 class="hasAnchor">
<a href="#relative-ordering" class="anchor"></a>Relative ordering</h2>
<p>In previous sections, we noted that there are arguments to <code>day_nonexistent</code> and <code>dst_nonexistent</code> that attempt to retain the sub-daily components of you date-time vector when resolving nonexistent date-times.</p>
<p>For <code>day_nonexistent</code>, these are <code>"last-day"</code> and <code>"first-day"</code>.</p>
<p>For <code>dst_nonexistent</code>, these are <code>"shift-forward"</code>, <code>"shift-backward"</code>, and <code>"shift-directional"</code>.</p>
<p>While these options can be useful in other situations, I would highly advise against using them when doing date-time arithmetic since none of these options preserve the <em>relative ordering</em> within your vector. To understand this, we’ll go through a few examples.</p>
<div id="nonexistent-dates-due-to-period-arithmetic-1" class="section level3">
<h3 class="hasAnchor">
<a href="#nonexistent-dates-due-to-period-arithmetic-1" class="anchor"></a>Nonexistent dates due to period arithmetic</h3>
<p>Consider this vector of two date-times. Clearly, <code>x[1]</code> happens before <code>x[2]</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1970-01-28 04:30:00"</span>, <span class="st">"1970-01-31 03:00:00"</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"America/New_York"</span><span class="op">)</span>

<span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></code></pre></div>
<p>What happens if you add 1 month to this vector, and want to keep the time of day? Note that the second element in the vector will have to consult <code>day_nonexistent</code> since <code>"1970-02-31"</code> doesn’t exist.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clock-arithmetic.html">add_months</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, day_nonexistent <span class="op">=</span> <span class="st">"last-day"</span><span class="op">)</span>

<span class="va">y</span></code></pre></div>
<p>This seems like a reasonable result at first, but on closer inspection you’ll notice that the ordering of the dates has flipped!</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">y</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></code></pre></div>
<p>This can wreak havoc in data science analyses with date-times. In particular, when computing a rolling average with a lookback period that is specified in months (like with the <code>slide_index()</code> function from the slider package), a calculation like this is performed to get the rolling “bounds” for the index:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">starts</span> <span class="op">&lt;-</span> <span class="va">index</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="va">stops</span> <span class="op">&lt;-</span> <span class="va">index</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></code></pre></div>
<p>It is often a requirement that <code>index</code> is an increasing series here, and similarly it is expected that <code>starts</code> and <code>stops</code> are also increasing. If the relative ordering is lost then you can’t ensure that this holds.</p>
<p>The defaults in clock will always preserve relative ordering. For <code>day_nonexistent</code>, it is always safe to use <code>"last-time"</code> and <code>"first-time"</code>. This is why <code>"last-time"</code> pins the time of day to the last possible second in the day.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clock-arithmetic.html">add_months</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, day_nonexistent <span class="op">=</span> <span class="st">"last-time"</span><span class="op">)</span>
<span class="va">z</span>

<span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></code></pre></div>
</div>
<div id="nonexistent-times-due-to-daylight-savings-gaps-1" class="section level3">
<h3 class="hasAnchor">
<a href="#nonexistent-times-due-to-daylight-savings-gaps-1" class="anchor"></a>nonexistent times due to daylight savings gaps</h3>
<p>Relative ordering can also be lost when daylight saving gaps are involved. For this example, <code>x[1]</code> is after <code>x[2]</code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1970-04-25 03:15:00"</span>, <span class="st">"1970-04-25 02:30:00"</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"America/New_York"</span><span class="op">)</span>

<span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></code></pre></div>
<p>If we added 1 day to this vector and used <code>"shift-forward"</code> to keep the time of day by “shifting” forward by the size of the gap, then we’d end up with:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, dst_nonexistent <span class="op">=</span> <span class="st">"shift-forward"</span><span class="op">)</span>
<span class="va">y</span>

<span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">y</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></code></pre></div>
<p>The relative ordering is lost!</p>
<p>The default option for <code>dst_nonexistent</code> of <code>"roll-directional"</code> will preserve relative ordering, as will choosing <code>"roll-forward"</code> or <code>"roll-backward"</code> directly. This is why <code>"roll-forward"</code> pins the time of day to the first possible second after the gap (and similar reasoning applies for <code>"roll-backward"</code>).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">z</span>

<span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></code></pre></div>
</div>
</div>
<div id="local-date-times" class="section level2">
<h2 class="hasAnchor">
<a href="#local-date-times" class="anchor"></a>Local date-times</h2>
<p>All of the examples so far have been focused on adding 1 unit of time at a time, i.e. “5 months” or “2 years”. Date-time math gets even more ambiguous when you try to add multiple units of time at once. For example, what would it mean to add “1 day and 1 hour” to the following date? Note that this crosses a daylight savings gap on the 26th.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"1970-04-25 02:30:00"</span>, <span class="st">"America/New_York"</span><span class="op">)</span>

<span class="co"># x + "1 day and 1 hour" = ?</span>
<span class="co">#</span>
<span class="co"># Possibly:</span>
<span class="co"># 1970-04-26 03:30:00</span></code></pre></div>
<p>The issue with adding multiple periods is that <code><a href="../reference/clock-arithmetic.html">add_days()</a></code> and friends will <em>immediately</em> try to fix any daylight savings issues (i.e. with <code>dst_nonexistent</code>) after each individual unit is added. This means that result of adding multiple periods can depend on the order in which you apply them.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># immediately applies `dst_nonexistent = "roll-forward"`</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/clock-arithmetic.html">add_hours</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>

<span class="va">x</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/clock-arithmetic.html">add_hours</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="co"># no need for `dst_nonexistent`, we are past the gap</span></code></pre></div>
<p>To avoid these issues, when working with multiple transformations it is often useful to temporarily transform from a <em>zoned</em> date-time to a <em>local</em> date-time.</p>
<p>A zoned date-time is one that has a time zone attached. All POSIXct objects are zoned. In the above example, <code>x</code> is associated with the <code>"America/New_York"</code> time zone. All Date objects are also zoned, they are implicitly assumed to be <code>"UTC"</code> throughout R.</p>
<p>A local date-time is one that isn’t associated with any time zones. This frees it from the issues that <code>dst_nonexistent</code> and <code>dst_ambiguous</code> have to handle.</p>
<p>To create a local date-time, use <code>localize()</code>. It prints with the same clock time as <code>x</code>, but notice how there is no time zone attached.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">local</span> <span class="op">&lt;-</span> <span class="fu">localize</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">local</span></code></pre></div>
<p>On the local timeline, we can add “1 day and 1 hour” without any fear of being affected by daylight savings. The order won’t matter here.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">%&gt;%</span>
  <span class="fu">localize</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/clock-arithmetic.html">add_hours</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>After performing the manipulations on the local timeline, we can convert back to a zoned date-time with <code>unlocalize()</code>. This requires a <code>zone</code> argument to specify which zone to convert back to, but we can just pull that from <code>x</code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">%&gt;%</span>
  <span class="fu">localize</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/clock-arithmetic.html">add_days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/clock-arithmetic.html">add_hours</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">unlocalize</span><span class="op">(</span><span class="fu">get_zone</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><code>unlocalize()</code> also has arguments for resolving any nonexistent or ambiguous daylight savings issues that might occur when converting from a local date-time to a zoned date-time. This is the only place that you should have to worry about daylight savings when working with a local date-time.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Davis Vaughan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
